# 监控

所有服务的状态，0,1，时间，服务标识，massage

每次采集和数据备份任务是否成功的状态 （0,1,-1），采集开始时间，结束时间，采集任务标识，massage，若未开始采集或备份，则状态为-1，任务失败或未开始，end_time传null

数据库连通性测试状态 （0,1），时间，数据库连接串，massage

监控服务要和其他被监控服务分开，不能置于同一个服务内

监控接口api返回json，每次调用返回此次检测结果即可，每种监控提供一个路径，提供GET方法即可

监控服务api和返回值示例如下：

**服务状态** http://监控地址/services

```json
[
    {
        name: "服务1",
        time: "2021-09-06 08:00:00",
        stauts: 0,
        msg: "Error,数据"
    },
    {
        name: "服务1",
        time: "2021-09-06 08:00:00",
        stauts: 1，
        msg: "服务正常"
    }
]
```
**每个服务状态** http://监控地址/service/<标识名>

```json
 {
     name: "服务1",
     time: "2021-09-06 08:00:00",
     stauts: 0,
     msg: "Error,数据"
 }
```

**采集或备份任务** http://监控地址/jobs

```json
[
    {
        name: "采集任务1",
        start_time: "2021-09-06 08:00:00",
        end_time: "2021-09-06 08:00:00",
        stauts: 1，
        msg: "采集完成"
    },
    {
        name: "数据备份任务1",
        start_time: "2021-09-06 08:00:00",
        end_time: "2021-09-06 08:00:00",
        stauts: -1，
        msg: "备份未开始"
    }
]
```

**每个服务状态** http://监控地址/job/<标识名>

```json
{
    name: "采集任务1",
    start_time: "2021-09-06 08:00:00",
    end_time: "2021-09-06 08:00:00",
    stauts: 1，
    msg: "采集完成"
}
```

**数据库联通性测试**，dsn具体形式无要求，能标识到数据库就可以

http://监控地址/dbs

```json
[
    {
        dsn: "pgsql:host=localhost;port=5432;dbname=testdb;user=bruce;",
        time: "2021-09-06 08:00:00",
        stauts: 1,
        msg: "连接成功"
    },
    {
        dsn: "mongodb://[username:password@]host1[:port1][,host2[:port2],...[,hostN[:portN]]][/[database][?options]]",
        time: "2021-09-06 08:00:00",
        stauts: 1,
        msg: "连接成功"
    }
]
```



安装命令

```
俩台服务器同时执行
mkdir -p /data/{webserver,work,backup,shell}
cd /data

下载安装包
wget http://vcmanager.jingdata.com/file/upgrade/nfdw/webserver.tar.gz
wget http://vcmanager.jingdata.com/file/upgrade/nfdw/shell.tar.gz
wget http://vcmanager.jingdata.com/file/upgrade/nfdw/filestore.tar.gz

将下载好的文件放在服务器/data/中解压
tar -xvf /data/webserver.tar.gz
tar -xvf /data/shell.tar.gz
tar -xvf /data/backup.tar.gz

mv filestore backup/

字体模块安装（存储服务器是否需要安装字体）
cd /data/backup/filestore/
sh filestore_install.sh

java环境安装（在应用部署服务器安装）
sh /data/shell/java_install.sh
source /etc/profile.d/java.sh

查看版本：java -version

Redis部署（在应用部署服务器安装）
Redis目录www用户权限：chown www:www /data/webserver/redis -R
切换用户：su www
启动redis：/data/webserver/redis/init.d/redis start
查看端口是否启动：netstat -ntlp，查看是否有6379端口在活，若没有则再执行一遍上述命令

Redis连接方式：
/data/webserver/redis/bin/redis-cli -h 192.168.1.121 -p 6379 -a OcSy6uD0W]C.
可访问Redis

Rocketmq部署（在应用部署服务器安装）
用Root账号给rocketmq目录www用户权限：chown www:www /data/webserver/rocketmq -R
切换用户：su www
执行：sh /data/webserver/rocketmq/rocketmq.sh
查看端口是否启动：netstat -ntlp 查看是否9876、10909、10911、10912

elasticsearch部署（在应用服务器安装，只存文章关键字，存储占用较小，比较吃内存）
Root用户执行：/data/shell/chushihua_es.sh
用Root账号给elasticsearch目录www用户权限：chown www:www /data/webserver/elasticsearch -R
cd /data/webserver/elasticsearch
su root
cd /data/webserver/elasticsearch
执行：sh es_monitor.sh
查看端口是否启动：netstat -ntlp 查看9200，9300端口是否在活

Postgresql数据库部署（在数据库服务器安装）
Root用户执行：cd /data/shell 
执行：sh chushihua_pg.sh
执行：source /etc/profile
切换用户su postgres
cd /data/webserver/postgresql
启动服务:./start.sh
查看端口是否启动：netstat -ntlp 查看5432端口是否在活
Postgresql数据库连接方式
/data/webserver/postgresql/bin/psql -h 127.0.0.1 -U postgres

创建数据库：create database szzf;
创建用户：create user gwyd with password 'szzf';
给用户数据库权限：grant all on database szzf TO gwyd;
修改用户密码：	
alter user postgres with password 'kh^%kfdk3ff23' 
\q 退出
导入数据：/data/webserver/postgresql/bin/psql -h 服务器ip -U gwyd -p 5432 -f /data/backup/szzf.sql

查看数据库：\l
切换数据库：\c 数据库名称
查看数据库中的所有表：\dt
查看表结构：\d  表名
查看表数据select * from 表名

mongodb部署（在数据库服务器安装）
root用户执行：cd /data/shell
vi chushihua_mongo.sh，其中写死了服务器地址，需要更改
sed -i s/172.20.0.151/服务器ip地址/g chushihua_mongo.sh
sh chushihua_mongo.sh
netstat -tnlp 查看 27017和27018端口是否在活

mougodb恢复数据：
/data/webserver/mongodb/bin/mongorestore --host 服务器ip:27017 -u admin -p admin --dir /data/backup/effektif
Mougodb登录数据库：
/data/webserver/mongodb/bin/mongo  服务器ip:27017/admin -u admin -p admin

查看数据库：show dbs

nginx部署（在应用部署服务器安装）
su root
执行：sh /data/shell/chushihua_hosts
Nginx 查看配置是否正确
/data/webserver/nginx/sbin/nginx -t

执行：/data/webserver/nginx/sbin/nginx
查看nginx端口是否启动：
netstat -ntlp，查看18080是否在活
nginx配置路径 /data/webserver/nginx/conf/krplus/site/
Nginx重载配置：
/data/webserver/nginx/sbin/nginx -s reload

Nginx重启：
/data/webserver/nginx/sbin/nginx -s restart








```

